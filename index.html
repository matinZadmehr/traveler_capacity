<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¸Ø±ÙÛŒØª ÙˆØ²Ù† Ù…Ø³Ø§ÙØ± | Carry to Me</title>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            direction: rtl;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
            padding: 25px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }
        
        h1 {
            color: #1a2980;
            margin-bottom: 8px;
            font-size: 22px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #666;
            font-size: 15px;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        /* Weight Display */
        .weight-display {
            text-align: center;
            margin: 30px 0;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px solid #dee2e6;
            position: relative;
        }
        
        .weight-main {
            font-size: 56px;
            font-weight: 800;
            color: #1a2980;
            margin-bottom: 5px;
            font-family: 'Courier New', monospace;
            line-height: 1;
        }
        
        .weight-unit {
            font-size: 28px;
            color: #26d0ce;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .weight-conversion {
            font-size: 18px;
            color: #666;
            background: white;
            padding: 8px 15px;
            border-radius: 25px;
            display: inline-block;
            border: 1px solid #ddd;
        }
        
        /* Slider Section */
        .slider-container {
            margin: 30px 0;
            padding: 0 10px;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            color: #666;
            font-size: 14px;
            font-weight: 600;
        }
        
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 16px;
            border-radius: 8px;
            background: linear-gradient(to right, #26d0ce, #1a2980, #4a00e0);
            outline: none;
            margin: 10px 0;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 4px solid #1a2980;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.2s;
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        
        .slider::-moz-range-thumb {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: 4px solid #1a2980;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .weight-markers {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            font-size: 13px;
            color: #888;
        }
        
        .marker {
            text-align: center;
            flex: 1;
            position: relative;
        }
        
        .marker::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 8px;
            background: #999;
        }
        
        /* Capacity Indicators */
        .capacity-indicators {
            display: flex;
            justify-content: space-between;
            margin: 25px 0;
            gap: 10px;
        }
        
        .capacity-indicator {
            flex: 1;
            text-align: center;
            padding: 15px;
            border-radius: 12px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .capacity-indicator:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .capacity-indicator.active {
            border-color: #1a2980;
            background: #e6f7ff;
        }
        
        .capacity-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .capacity-value {
            font-size: 18px;
            font-weight: 700;
            color: #1a2980;
        }
        
        /* Quick Select Buttons */
        .quick-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .quick-btn {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-weight: 600;
            color: #555;
            transition: all 0.3s;
            text-align: center;
        }
        
        .quick-btn:hover {
            border-color: #1a2980;
            color: #1a2980;
            background: #f0f8ff;
        }
        
        .quick-btn:active {
            transform: scale(0.98);
        }
        
        /* Info Section */
        .info-section {
            background: #e6f7ff;
            padding: 20px;
            border-radius: 15px;
            margin: 25px 0;
            border-right: 4px solid #1a2980;
        }
        
        .info-title {
            color: #1a2980;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-text {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Buttons */
        .buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, #1a2980 0%, #26d0ce 100%);
            color: white;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(26, 41, 128, 0.3);
        }
        
        .cancel-btn {
            background: #f5f5f5;
            color: #666;
            border: 2px solid #e0e0e0;
        }
        
        .cancel-btn:hover {
            background: #e0e0e0;
        }
        
        /* Status Messages */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #1a2980;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        .error-message {
            display: none;
            text-align: center;
            padding: 15px;
            background: #ffebee;
            border-radius: 10px;
            margin: 20px 0;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }
        
        .success-message {
            display: none;
            text-align: center;
            padding: 40px 20px;
        }
        
        .success-icon {
            font-size: 80px;
            color: #2ecc71;
            margin-bottom: 20px;
        }
        
        /* Test Mode Notice */
        .test-notice {
            text-align: center;
            padding: 10px;
            background: #fff3e0;
            border-radius: 10px;
            margin: 20px 0;
            color: #ef6c00;
            font-size: 14px;
            border: 1px solid #ffcc80;
        }
        
        /* Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .pulse {
            animation: pulse 0.5s ease;
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .container {
                padding: 20px;
            }
            
            .weight-main {
                font-size: 48px;
            }
            
            .weight-unit {
                font-size: 24px;
            }
            
            .quick-select {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .capacity-indicators {
                flex-direction: column;
            }
            
            .buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ‹ï¸</div>
            <h1>Ø¸Ø±ÙÛŒØª ÙˆØ²Ù† Ù…Ø³Ø§ÙØ±</h1>
            <p class="subtitle">Ú†Ù‚Ø¯Ø± ÙˆØ²Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‡Ù…Ø±Ø§Ù‡ Ø®ÙˆØ¯ Ø¨Ø¨Ø±ÛŒØ¯ØŸ</p>
        </div>
        
        <!-- Test Mode Notice -->
        <div class="test-notice" id="testNotice" style="display: none;">
            <strong>âš ï¸ Ø­Ø§Ù„Øª ØªØ³Øª:</strong> Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø®Ø§Ø±Ø¬ Ø§Ø² ØªÙ„Ú¯Ø±Ø§Ù…
        </div>
        
        <!-- Error Message -->
        <div class="error-message" id="errorMessage">
            <i class="fas fa-exclamation-triangle"></i>
            <p id="errorText">Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</p>
        </div>
        
        <!-- Weight Display -->
        <div class="weight-display">
            <div class="weight-main" id="weightValue">0.5</div>
            <div class="weight-unit" id="weightUnit">Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…</div>
            <div class="weight-conversion" id="weightConversion">(500 Ú¯Ø±Ù…)</div>
        </div>
        
        <!-- Slider -->
        <div class="slider-container">
            <div class="slider-labels">
                <span>Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±</span>
                <span>Ù†ÛŒÙ…Ù‡ Ø¸Ø±ÙÛŒØª</span>
                <span>Ø¸Ø±ÙÛŒØª Ú©Ø§Ù…Ù„</span>
            </div>
            <input type="range" min="0.1" max="50" step="0.1" value="0.5" class="slider" id="weightSlider">
            <div class="weight-markers">
                <div class="marker">Ø³Ø¨Ú©</div>
                <div class="marker">Ù…ØªÙˆØ³Ø·</div>
                <div class="marker">Ø³Ù†Ú¯ÛŒÙ†</div>
                <div class="marker">Ø®ÛŒÙ„ÛŒ Ø³Ù†Ú¯ÛŒÙ†</div>
            </div>
        </div>
        
        <!-- Quick Select Buttons -->
        <div class="quick-select">
            <button class="quick-btn" onclick="setWeight(0.5)">0.5 Ú©ÛŒÙ„Ùˆ</button>
            <button class="quick-btn" onclick="setWeight(1)">1 Ú©ÛŒÙ„Ùˆ</button>
            <button class="quick-btn" onclick="setWeight(2)">2 Ú©ÛŒÙ„Ùˆ</button>
            <button class="quick-btn" onclick="setWeight(5)">5 Ú©ÛŒÙ„Ùˆ</button>
            <button class="quick-btn" onclick="setWeight(10)">10 Ú©ÛŒÙ„Ùˆ</button>
            <button class="quick-btn" onclick="setWeight(20)">20 Ú©ÛŒÙ„Ùˆ</button>
        </div>
        
        <!-- Capacity Indicators -->
        <div class="capacity-indicators">
            <div class="capacity-indicator" data-capacity="low" onclick="setCapacity('low')">
                <div class="capacity-title">Ø¸Ø±ÙÛŒØª Ú©Ù…</div>
                <div class="capacity-value">ØªØ§ 5 Ú©ÛŒÙ„Ùˆ</div>
                <small>Ú©ÛŒÙ Ø¯Ø³ØªÛŒ</small>
            </div>
            <div class="capacity-indicator active" data-capacity="medium" onclick="setCapacity('medium')">
                <div class="capacity-title">Ø¸Ø±ÙÛŒØª Ù…ØªÙˆØ³Ø·</div>
                <div class="capacity-value">5-15 Ú©ÛŒÙ„Ùˆ</div>
                <small>Ú†Ù…Ø¯Ø§Ù† Ú©ÙˆÚ†Ú©</small>
            </div>
            <div class="capacity-indicator" data-capacity="high" onclick="setCapacity('high')">
                <div class="capacity-title">Ø¸Ø±ÙÛŒØª Ø¨Ø§Ù„Ø§</div>
                <div class="capacity-value">15+ Ú©ÛŒÙ„Ùˆ</div>
                <small>Ú†Ù…Ø¯Ø§Ù† Ø¨Ø²Ø±Ú¯</small>
            </div>
        </div>
        
        <!-- Info Section -->
        <div class="info-section">
            <div class="info-title">
                <i class="fas fa-info-circle"></i>
                Ù†Ú©Ø§Øª Ù…Ù‡Ù…:
            </div>
            <div class="info-text">
                â€¢ ÙˆØ²Ù† Ø§Ø¹Ù„Ø§Ù… Ø´Ø¯Ù‡ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ù‚Ø¹ÛŒ Ùˆ Ù‚Ø§Ø¨Ù„ Ø­Ù…Ù„ Ø¨Ø§Ø´Ø¯<br>
                â€¢ Ø­Ø¯Ø§Ú©Ø«Ø± ÙˆØ²Ù† Ù…Ø¬Ø§Ø² Ù‡ÙˆØ§Ù¾ÛŒÙ…Ø§ Ù…Ø¹Ù…ÙˆÙ„Ø§Ù‹ 30 Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù… Ø§Ø³Øª<br>
                â€¢ ÙˆØ²Ù† Ú©Ù…ØªØ± Ø§Ø² 1 Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù… Ø¨Ù‡ Ú¯Ø±Ù… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯<br>
                â€¢ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§ÛŒÙ† Ù…Ù‚Ø¯Ø§Ø± Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯
            </div>
        </div>
        
        <!-- Buttons -->
        <div class="buttons">
            <button class="cancel-btn" onclick="cancelProcess()">
                <i class="fas fa-times"></i> Ø§Ù†ØµØ±Ø§Ù
            </button>
            <button class="submit-btn" onclick="submitCapacity()">
                <i class="fas fa-check"></i> ØªØ£ÛŒÛŒØ¯ Ø¸Ø±ÙÛŒØª
            </button>
        </div>
        
        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø¸Ø±ÙÛŒØª...</p>
        </div>
        
        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            <div class="success-icon"><i class="fas fa-check-circle"></i></div>
            <h2>Ø¸Ø±ÙÛŒØª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯!</h2>
            <p>Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø­Ù…Ù„ Ø¨Ø§Ø± Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯.</p>
            <p style="margin-top: 20px; color: #7f8c8d; font-size: 14px;">Ø§ÛŒÙ† Ù¾Ù†Ø¬Ø±Ù‡ Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø³ØªÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯...</p>
        </div>
    </div>
    
    <script>
        // Global variables
        let tg = null;
        let isTelegramWebApp = false;
        
        // CONFIGURATION - SET YOUR WEBHOOK URLS HERE
        const WEBHOOK_URL = 'https://your-domain.com/webhook_capacity.php'; // â† Change this!
        
        // Store capacity data
        let capacityData = {
            available_weight_kg: 0.5,
            weight_display: "0.5 Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…",
            capacity_level: "medium",
            timestamp: null,
            traveler_status: "active"
        };
        
        // Capacity level definitions
        const capacityLevels = {
            low: { min: 0.1, max: 5, label: "Ú©Ù…", description: "Ú©ÛŒÙ Ø¯Ø³ØªÛŒ" },
            medium: { min: 5, max: 15, label: "Ù…ØªÙˆØ³Ø·", description: "Ú†Ù…Ø¯Ø§Ù† Ú©ÙˆÚ†Ú©" },
            high: { min: 15, max: 50, label: "Ø²ÛŒØ§Ø¯", description: "Ú†Ù…Ø¯Ø§Ù† Ø¨Ø²Ø±Ú¯" }
        };
        
        // Initialize Telegram Web App
        function initTelegramWebApp() {
            console.log('Initializing Telegram Web App...');
            
            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    tg = window.Telegram.WebApp;
                    isTelegramWebApp = true;
                    
                    console.log('Telegram Web App detected');
                    console.log('Platform:', tg.platform);
                    
                    // Initialize Telegram Web App
                    tg.ready();
                    tg.expand();
                    tg.MainButton.hide();
                    
                    // Set theme params if needed
                    if (tg.colorScheme === 'dark') {
                        document.body.style.background = '#1a1a1a';
                        document.querySelector('.container').style.background = '#2d2d2d';
                        document.querySelector('.container').style.color = '#ffffff';
                    }
                    
                    return true;
                    
                } catch (error) {
                    console.error('Error initializing Telegram Web App:', error);
                    showError('Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ ØªÙ„Ú¯Ø±Ø§Ù…');
                    return false;
                }
            } else {
                console.warn('Telegram Web App SDK not found. Running in test mode.');
                document.getElementById('testNotice').style.display = 'block';
                return false;
            }
        }
        
        // Show error message
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
            }, 5000);
        }
        
        // Format weight display
        function formatWeight(kg) {
            if (kg < 1) {
                // Convert to grams
                const grams = Math.round(kg * 1000);
                return {
                    display: grams,
                    unit: "Ú¯Ø±Ù…",
                    conversion: `(${kg} Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…)`,
                    fullText: `${grams} Ú¯Ø±Ù…`,
                    isGrams: true
                };
            } else {
                // Show in kg with 1 decimal if needed
                const displayKg = kg % 1 === 0 ? kg : kg.toFixed(1);
                return {
                    display: displayKg,
                    unit: "Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…",
                    conversion: `(${Math.round(kg * 1000)} Ú¯Ø±Ù…)`,
                    fullText: `${displayKg} Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…`,
                    isGrams: false
                };
            }
        }
        
        // Update weight display
        function updateWeightDisplay() {
            const weight = parseFloat(document.getElementById('weightSlider').value);
            const formatted = formatWeight(weight);
            
            // Update display elements with animation
            const weightValue = document.getElementById('weightValue');
            const weightUnit = document.getElementById('weightUnit');
            const weightConversion = document.getElementById('weightConversion');
            
            weightValue.textContent = formatted.display;
            weightUnit.textContent = formatted.unit;
            weightConversion.textContent = formatted.conversion;
            
            // Add pulse animation
            weightValue.classList.add('pulse');
            setTimeout(() => {
                weightValue.classList.remove('pulse');
            }, 500);
            
            // Update capacity level based on weight
            updateCapacityLevel(weight);
            
            // Update capacity data
            capacityData.available_weight_kg = weight;
            capacityData.weight_display = formatted.fullText;
        }
        
        // Update capacity level based on weight
        function updateCapacityLevel(weight) {
            let newLevel = "medium";
            
            if (weight <= 5) {
                newLevel = "low";
            } else if (weight <= 15) {
                newLevel = "medium";
            } else {
                newLevel = "high";
            }
            
            // Update active indicator
            document.querySelectorAll('.capacity-indicator').forEach(indicator => {
                indicator.classList.remove('active');
            });
            document.querySelector(`.capacity-indicator[data-capacity="${newLevel}"]`).classList.add('active');
            
            capacityData.capacity_level = newLevel;
        }
        
        // Set weight via quick buttons
        function setWeight(kg) {
            const slider = document.getElementById('weightSlider');
            slider.value = kg;
            updateWeightDisplay();
            
            // Highlight the clicked button
            document.querySelectorAll('.quick-btn').forEach(btn => {
                btn.style.borderColor = '#e0e0e0';
                btn.style.background = 'white';
                btn.style.color = '#555';
            });
            
            // Find and highlight the clicked button
            const clickedBtn = Array.from(document.querySelectorAll('.quick-btn')).find(btn => 
                btn.textContent.includes(`${kg}`)
            );
            if (clickedBtn) {
                clickedBtn.style.borderColor = '#1a2980';
                clickedBtn.style.background = '#f0f8ff';
                clickedBtn.style.color = '#1a2980';
            }
        }
        
        // Set capacity level
        function setCapacity(level) {
            const capacity = capacityLevels[level];
            if (!capacity) return;
            
            // Set weight to the middle of the range
            const targetWeight = (capacity.min + capacity.max) / 2;
            setWeight(targetWeight);
        }
        
        // Send data to webhook
        async function sendToWebhook(data) {
            try {
                console.log('Sending capacity data to webhook:', data);
                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                console.log('Webhook response:', result);
                
                return result.success;
                
            } catch (error) {
                console.error('Error sending to webhook:', error);
                return false;
            }
        }
        
        // Get user IP address
        async function getUserIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                return data.ip;
            } catch (error) {
                return 'unknown';
            }
        }
        
        // Main submit function
        async function submitCapacity() {
            const weight = capacityData.available_weight_kg;
            
            // Validate weight
            if (weight < 0.1 || weight > 50) {
                showError('Ù„Ø·ÙØ§ ÙˆØ²Ù† Ù…Ø¹ØªØ¨Ø±ÛŒ Ø¨ÛŒÙ† Û°.Û± ØªØ§ ÛµÛ° Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù… ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.querySelector('.buttons').style.display = 'none';
            
            // Get Telegram user info if available
            let telegramUser = {};
            if (isTelegramWebApp && tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
                telegramUser = {
                    telegram_id: tg.initDataUnsafe.user.id,
                    telegram_username: tg.initDataUnsafe.user.username,
                    telegram_first_name: tg.initDataUnsafe.user.first_name,
                    telegram_last_name: tg.initDataUnsafe.user.last_name,
                    telegram_language_code: tg.initDataUnsafe.user.language_code
                };
            }
            
            // Get capacity level details
            const capacityLevel = capacityLevels[capacityData.capacity_level];
            
            // Prepare data to send
            const data = {
                action: 'traveler_capacity_declared',
                timestamp: new Date().toISOString(),
                capacity_info: {
                    available_weight: {
                        kg: capacityData.available_weight_kg,
                        grams: Math.round(capacityData.available_weight_kg * 1000),
                        display: capacityData.weight_display,
                        is_under_1kg: capacityData.available_weight_kg < 1
                    },
                    capacity_level: {
                        id: capacityData.capacity_level,
                        label: capacityLevel.label,
                        description: capacityLevel.description,
                        min_kg: capacityLevel.min,
                        max_kg: capacityLevel.max
                    },
                    traveler_type: getTravelerType(capacityData.available_weight_kg),
                    can_carry_more: capacityData.available_weight_kg < 30
                },
                telegram_user: telegramUser,
                source: 'telegram_traveler_capacity_web_app',
                ip_address: await getUserIP(),
                metadata: {
                    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                    user_agent: navigator.userAgent,
                    language: navigator.language,
                    device_type: /Mobi|Android/i.test(navigator.userAgent) ? 'mobile' : 'desktop'
                }
            };
            
            console.log('Capacity data to send:', data);
            
            // Send data using multiple methods (with fallbacks)
            let success = false;
            
            // Method 1: Send to webhook.php
            if (WEBHOOK_URL && !WEBHOOK_URL.includes('your-domain.com')) {
                success = await sendToWebhook(data);
            }
            
            // Method 2: Try Telegram sendData as fallback
            if (!success && isTelegramWebApp && tg && tg.sendData) {
                try {
                    tg.sendData(JSON.stringify(data));
                    success = true;
                    console.log('Data sent via Telegram sendData');
                } catch (error) {
                    console.error('Telegram sendData error:', error);
                }
            }
            
            // If all methods failed and we're not in Telegram, consider it success for testing
            if (!success && !isTelegramWebApp) {
                console.log('Test mode: Data logged to console');
                success = true; // For testing purposes
            }
            
            // Show success message
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('successMessage').style.display = 'block';
                
                // Close after 3 seconds if in Telegram
                setTimeout(() => {
                    if (isTelegramWebApp && tg && tg.close) {
                        tg.close();
                    } else {
                        // Show manual close message for browser
                        document.getElementById('successMessage').innerHTML += 
                            '<p style="margin-top: 20px; color: #7f8c8d; font-size: 14px;">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§ÛŒÙ† Ù¾Ù†Ø¬Ø±Ù‡ Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒØ¯.</p>';
                    }
                }, 3000);
                
            }, 1500);
        }
        
        // Determine traveler type based on capacity
        function getTravelerType(weight) {
            if (weight <= 2) return 'light_traveler';
            if (weight <= 10) return 'standard_traveler';
            if (weight <= 20) return 'heavy_traveler';
            return 'extra_capacity_traveler';
        }
        
        function cancelProcess() {
            if (isTelegramWebApp && tg && tg.close) {
                tg.close();
            } else {
                if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                    window.location.reload();
                }
            }
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Telegram Web App
            const telegramInitialized = initTelegramWebApp();
            
            // Setup weight slider
            const weightSlider = document.getElementById('weightSlider');
            weightSlider.addEventListener('input', updateWeightDisplay);
            
            // Set initial display
            updateWeightDisplay();
            
            // Add test button if not in Telegram
            if (!telegramInitialized) {
                const testButton = document.createElement('button');
                testButton.innerHTML = 'ğŸ§ª ØªØ³Øª Ø§Ø±Ø³Ø§Ù„ (Ø¨Ø¯ÙˆÙ† ØªÙ„Ú¯Ø±Ø§Ù…)';
                testButton.style.cssText = `
                    background: #ff9800;
                    color: white;
                    border: none;
                    padding: 12px;
                    border-radius: 10px;
                    margin-top: 15px;
                    width: 100%;
                    font-weight: bold;
                    cursor: pointer;
                `;
                testButton.onclick = function() {
                    console.log('Test mode activated');
                    
                    // Set random weight for testing
                    const testWeight = Math.floor(Math.random() * 30) + 0.5;
                    setWeight(testWeight);
                    
                    // Submit after a short delay
                    setTimeout(() => {
                        submitCapacity();
                    }, 1000);
                };
                document.querySelector('.buttons').appendChild(testButton);
            }
            
            // Check if webhook URL is configured
            if (WEBHOOK_URL.includes('your-domain.com')) {
                showError('Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³ ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø±Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø¯ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
            }
        });
    </script>
</body>
</html>